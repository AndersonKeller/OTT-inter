{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport SafeJSONParse from 'json-parse-safe';\nimport React, { useContext, useEffect } from 'react';\nimport Router from 'next/router';\nimport nookies from 'nookies';\nimport UserContext from '~/contexts/UserContext';\nimport withApi from '~/components/withApi';\n\nvar withAuth = function withAuth(WrappedComponent) {\n  var update = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n  var WithAuth = function WithAuth(props) {\n    var _useContext = useContext(UserContext),\n        user = _useContext.user,\n        updateUser = _useContext.updateUser;\n\n    useEffect(function (_) {\n      if (!user) {\n        Router.push('/');\n      }\n    }, [user]);\n    return __jsx(WrappedComponent, _extends({\n      updateUser: updateUser\n    }, props));\n  };\n\n  WithAuth.getInitialProps = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(ctx) {\n      var api, user, _yield$api$get, data, _nookies$get, userString, pathname, res, redirectRoute, componentProps;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              api = ctx.api;\n\n              if (!update) {\n                _context.next = 15;\n                break;\n              }\n\n              _context.prev = 2;\n              _context.next = 5;\n              return api.get('user');\n\n            case 5:\n              _yield$api$get = _context.sent;\n              data = _yield$api$get.data;\n              user = data; // set user to cookies\n\n              nookies.set(ctx, 'user', JSON.stringify(user), {\n                path: '/'\n              });\n              _context.next = 13;\n              break;\n\n            case 11:\n              _context.prev = 11;\n              _context.t0 = _context[\"catch\"](2);\n\n            case 13:\n              _context.next = 17;\n              break;\n\n            case 15:\n              _nookies$get = nookies.get(ctx, 'user'), userString = _nookies$get.user;\n              user = SafeJSONParse(userString).value;\n\n            case 17:\n              if (user) {\n                _context.next = 23;\n                break;\n              }\n\n              pathname = ctx.pathname, res = ctx.res;\n              redirectRoute = \"/login?redirectTo=\".concat(pathname);\n              console.log('redirectroute', redirectRoute);\n\n              if (res) {\n                res.redirect(redirectRoute);\n                res.end();\n              } else {\n                Router.replace(redirectRoute);\n              }\n\n              return _context.abrupt(\"return\", {});\n\n            case 23:\n              if (!WrappedComponent.getInitialProps) {\n                _context.next = 31;\n                break;\n              }\n\n              // append user to the context\n              ctx.user = user;\n              _context.next = 27;\n              return WrappedComponent.getInitialProps(ctx);\n\n            case 27:\n              componentProps = _context.sent;\n              return _context.abrupt(\"return\", _objectSpread({\n                user: user\n              }, componentProps));\n\n            case 31:\n              return _context.abrupt(\"return\", {\n                user: user\n              });\n\n            case 32:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[2, 11]]);\n    }));\n\n    return function (_x) {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  WithAuth.displayName = \"WithAuth(\".concat(getDisplayName(WrappedComponent), \")\"); // wrap this hoc on withApi hoc\n\n  return withApi(WithAuth);\n};\n\nfunction getDisplayName(WrappedComponent) {\n  return WrappedComponent.displayName || WrappedComponent.name || 'Component';\n}\n\nexport default withAuth;","map":{"version":3,"sources":["/Users/rafael/Projects/somosgad/dale/components/withAuth/index.js"],"names":["SafeJSONParse","React","useContext","useEffect","Router","nookies","UserContext","withApi","withAuth","WrappedComponent","update","WithAuth","props","user","updateUser","_","push","getInitialProps","ctx","api","get","data","set","JSON","stringify","path","userString","value","pathname","res","redirectRoute","console","log","redirect","end","replace","componentProps","displayName","getDisplayName","name"],"mappings":";;;;;;;;;;AAAA,OAAOA,aAAP,MAA0B,iBAA1B;AACA,OAAOC,KAAP,IAAgBC,UAAhB,EAA4BC,SAA5B,QAA6C,OAA7C;AACA,OAAOC,MAAP,MAAmB,aAAnB;AACA,OAAOC,OAAP,MAAoB,SAApB;AACA,OAAOC,WAAP,MAAwB,wBAAxB;AACA,OAAOC,OAAP,MAAoB,sBAApB;;AAEA,IAAMC,QAAQ,GAAG,SAAXA,QAAW,CAACC,gBAAD,EAAsC;AAAA,MAAnBC,MAAmB,uEAAV,KAAU;;AAErD,MAAMC,QAAQ,GAAG,SAAXA,QAAW,CAAAC,KAAK,EAAI;AAAA,sBACKV,UAAU,CAACI,WAAD,CADf;AAAA,QAChBO,IADgB,eAChBA,IADgB;AAAA,QACVC,UADU,eACVA,UADU;;AAExBX,IAAAA,SAAS,CAAE,UAAAY,CAAC,EAAI;AACd,UAAK,CAAEF,IAAP,EAAa;AACXT,QAAAA,MAAM,CAACY,IAAP,CAAY,GAAZ;AACD;AACF,KAJQ,EAIN,CAACH,IAAD,CAJM,CAAT;AAKA,WAAO,MAAC,gBAAD;AAAkB,MAAA,UAAU,EAAEC;AAA9B,OAA8CF,KAA9C,EAAP;AACD,GARD;;AAUAD,EAAAA,QAAQ,CAACM,eAAT;AAAA,wEAA2B,iBAAMC,GAAN;AAAA;;AAAA;AAAA;AAAA;AAAA;AACjBC,cAAAA,GADiB,GACTD,GADS,CACjBC,GADiB;;AAAA,mBAGrBT,MAHqB;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,qBAOES,GAAG,CAACC,GAAJ,CAAQ,MAAR,CAPF;;AAAA;AAAA;AAObC,cAAAA,IAPa,kBAObA,IAPa;AAQrBR,cAAAA,IAAI,GAAGQ,IAAP,CARqB,CAUrB;;AACAhB,cAAAA,OAAO,CAACiB,GAAR,CAAYJ,GAAZ,EAAiB,MAAjB,EAAyBK,IAAI,CAACC,SAAL,CAAeX,IAAf,CAAzB,EAA+C;AAAEY,gBAAAA,IAAI,EAAE;AAAR,eAA/C;AAXqB;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA,6BAeMpB,OAAO,CAACe,GAAR,CAAYF,GAAZ,EAAiB,MAAjB,CAfN,EAeTQ,UAfS,gBAefb,IAfe;AAgBvBA,cAAAA,IAAI,GAAGb,aAAa,CAAC0B,UAAD,CAAb,CAA0BC,KAAjC;;AAhBuB;AAAA,kBAkBlBd,IAlBkB;AAAA;AAAA;AAAA;;AAmBfe,cAAAA,QAnBe,GAmBGV,GAnBH,CAmBfU,QAnBe,EAmBLC,GAnBK,GAmBGX,GAnBH,CAmBLW,GAnBK;AAoBjBC,cAAAA,aApBiB,+BAoBoBF,QApBpB;AAqBvBG,cAAAA,OAAO,CAACC,GAAR,CAAY,eAAZ,EAA6BF,aAA7B;;AACA,kBAAID,GAAJ,EAAS;AACPA,gBAAAA,GAAG,CAACI,QAAJ,CAAaH,aAAb;AACAD,gBAAAA,GAAG,CAACK,GAAJ;AACD,eAHD,MAGO;AACL9B,gBAAAA,MAAM,CAAC+B,OAAP,CAAeL,aAAf;AACD;;AA3BsB,+CA4BhB,EA5BgB;;AAAA;AAAA,mBA8BrBrB,gBAAgB,CAACQ,eA9BI;AAAA;AAAA;AAAA;;AAgCvB;AACAC,cAAAA,GAAG,CAACL,IAAJ,GAAWA,IAAX;AAjCuB;AAAA,qBAmCMJ,gBAAgB,CAACQ,eAAjB,CAAiCC,GAAjC,CAnCN;;AAAA;AAmCjBkB,cAAAA,cAnCiB;AAAA;AAoCdvB,gBAAAA,IAAI,EAAJA;AApCc,iBAoCLuB,cApCK;;AAAA;AAAA,+CAsChB;AAAEvB,gBAAAA,IAAI,EAAJA;AAAF,eAtCgB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAA3B;;AAAA;AAAA;AAAA;AAAA;;AA0CAF,EAAAA,QAAQ,CAAC0B,WAAT,sBAAmCC,cAAc,CAAC7B,gBAAD,CAAjD,OAtDqD,CAwDrD;;AACA,SAAOF,OAAO,CAACI,QAAD,CAAd;AACD,CA1DD;;AA4DA,SAAS2B,cAAT,CAAwB7B,gBAAxB,EAA0C;AACxC,SAAOA,gBAAgB,CAAC4B,WAAjB,IAAgC5B,gBAAgB,CAAC8B,IAAjD,IAAyD,WAAhE;AACD;;AAED,eAAe/B,QAAf","sourcesContent":["import SafeJSONParse from 'json-parse-safe'\nimport React, { useContext, useEffect } from 'react'\nimport Router from 'next/router'\nimport nookies from 'nookies'\nimport UserContext from '~/contexts/UserContext'\nimport withApi from '~/components/withApi'\n\nconst withAuth = (WrappedComponent, update = false) => {\n\n  const WithAuth = props => {\n    const { user, updateUser } = useContext(UserContext)\n    useEffect( _ => {\n      if ( ! user) {\n        Router.push('/')\n      }\n    }, [user])\n    return <WrappedComponent updateUser={updateUser} {...props} />\n  }\n\n  WithAuth.getInitialProps = async ctx => {\n    const { api } = ctx\n    let user\n    if (update) {\n      try {\n\n        // get updated user\n        const { data } = await api.get('user')\n        user = data\n\n        // set user to cookies\n        nookies.set(ctx, 'user', JSON.stringify(user), { path: '/' })\n\n      } catch(error) { }\n    } else {\n      const { user: userString } = nookies.get(ctx, 'user')\n      user = SafeJSONParse(userString).value\n    }\n    if ( ! user ) {\n      const { pathname, res } = ctx\n      const redirectRoute = `/login?redirectTo=${pathname}`\n      console.log('redirectroute', redirectRoute)\n      if (res) {\n        res.redirect(redirectRoute)\n        res.end()\n      } else {\n        Router.replace(redirectRoute)\n      }\n      return { }\n    }\n    if (WrappedComponent.getInitialProps) {\n\n      // append user to the context\n      ctx.user = user\n\n      const componentProps = await WrappedComponent.getInitialProps(ctx)\n      return { user, ...componentProps }\n    } else {\n      return { user }\n    }\n  }\n\n  WithAuth.displayName = `WithAuth(${getDisplayName(WrappedComponent)})`;\n\n  // wrap this hoc on withApi hoc\n  return withApi(WithAuth)\n}\n\nfunction getDisplayName(WrappedComponent) {\n  return WrappedComponent.displayName || WrappedComponent.name || 'Component';\n}\n\nexport default withAuth\n"]},"metadata":{},"sourceType":"module"}