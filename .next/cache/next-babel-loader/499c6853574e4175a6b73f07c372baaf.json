{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/esm/defineProperty\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/esm/asyncToGenerator\"));\n\nvar _extends2 = _interopRequireDefault(require(\"@babel/runtime/helpers/esm/extends\"));\n\nvar _jsonParseSafe = _interopRequireDefault(require(\"json-parse-safe\"));\n\nvar _react = _interopRequireWildcard(require(\"react\"));\n\nvar _router = _interopRequireDefault(require(\"next/router\"));\n\nvar _nookies = _interopRequireDefault(require(\"nookies\"));\n\nvar _UserContext = _interopRequireDefault(require(\"~/contexts/UserContext\"));\n\nvar _withApi = _interopRequireDefault(require(\"~/components/withApi\"));\n\nimport React from \"react\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nvar withAuth = function withAuth(WrappedComponent) {\n  var _s = $RefreshSig$();\n\n  var update = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n  var WithAuth = function WithAuth(props) {\n    _s();\n\n    var _useContext = (0, _react.useContext)(_UserContext[\"default\"]),\n        user = _useContext.user,\n        updateUser = _useContext.updateUser;\n\n    (0, _react.useEffect)(function (_) {\n      if (!user) {\n        _router[\"default\"].push('/');\n      }\n    }, [user]);\n    return __jsx(WrappedComponent, (0, _extends2[\"default\"])({\n      updateUser: updateUser\n    }, props));\n  };\n\n  _s(WithAuth, \"E1IPi7zVnqRXyPyOz10dSF8ywnM=\");\n\n  WithAuth.getInitialProps = /*#__PURE__*/function () {\n    var _ref = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(ctx) {\n      var api, user, _yield$api$get, data, _nookies$get, userString, pathname, res, redirectRoute, componentProps;\n\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              api = ctx.api;\n\n              if (!update) {\n                _context.next = 15;\n                break;\n              }\n\n              _context.prev = 2;\n              _context.next = 5;\n              return api.get('user');\n\n            case 5:\n              _yield$api$get = _context.sent;\n              data = _yield$api$get.data;\n              user = data; // set user to cookies\n\n              _nookies[\"default\"].set(ctx, 'user', JSON.stringify(user), {\n                path: '/'\n              });\n\n              _context.next = 13;\n              break;\n\n            case 11:\n              _context.prev = 11;\n              _context.t0 = _context[\"catch\"](2);\n\n            case 13:\n              _context.next = 17;\n              break;\n\n            case 15:\n              _nookies$get = _nookies[\"default\"].get(ctx, 'user'), userString = _nookies$get.user;\n              user = (0, _jsonParseSafe[\"default\"])(userString).value;\n\n            case 17:\n              if (user) {\n                _context.next = 23;\n                break;\n              }\n\n              pathname = ctx.pathname, res = ctx.res;\n              redirectRoute = \"/login?redirectTo=\".concat(pathname);\n              console.log('redirectroute', redirectRoute);\n\n              if (res) {\n                res.redirect(redirectRoute);\n                res.end();\n              } else {\n                _router[\"default\"].replace(redirectRoute);\n              }\n\n              return _context.abrupt(\"return\", {});\n\n            case 23:\n              if (!WrappedComponent.getInitialProps) {\n                _context.next = 31;\n                break;\n              }\n\n              // append user to the context\n              ctx.user = user;\n              _context.next = 27;\n              return WrappedComponent.getInitialProps(ctx);\n\n            case 27:\n              componentProps = _context.sent;\n              return _context.abrupt(\"return\", _objectSpread({\n                user: user\n              }, componentProps));\n\n            case 31:\n              return _context.abrupt(\"return\", {\n                user: user\n              });\n\n            case 32:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[2, 11]]);\n    }));\n\n    return function (_x) {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  WithAuth.displayName = \"WithAuth(\".concat(getDisplayName(WrappedComponent), \")\"); // wrap this hoc on withApi hoc\n\n  return (0, _withApi[\"default\"])(WithAuth);\n};\n\nfunction getDisplayName(WrappedComponent) {\n  return WrappedComponent.displayName || WrappedComponent.name || 'Component';\n}\n\nvar _default = withAuth;\nexports[\"default\"] = _default;","map":{"version":3,"sources":["/Users/rafael/Projects/somosgad/dale/components/withAuth/index.js"],"names":["withAuth","WrappedComponent","update","WithAuth","props","UserContext","user","updateUser","_","Router","push","getInitialProps","ctx","api","get","data","nookies","set","JSON","stringify","path","userString","value","pathname","res","redirectRoute","console","log","redirect","end","replace","componentProps","displayName","getDisplayName","name"],"mappings":"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","sourcesContent":["import SafeJSONParse from 'json-parse-safe'\nimport React, { useContext, useEffect } from 'react'\nimport Router from 'next/router'\nimport nookies from 'nookies'\nimport UserContext from '~/contexts/UserContext'\nimport withApi from '~/components/withApi'\n\nconst withAuth = (WrappedComponent, update = false) => {\n\n  const WithAuth = props => {\n    const { user, updateUser } = useContext(UserContext)\n    useEffect( _ => {\n      if ( ! user) {\n        Router.push('/')\n      }\n    }, [user])\n    return <WrappedComponent updateUser={updateUser} {...props} />\n  }\n\n  WithAuth.getInitialProps = async ctx => {\n    const { api } = ctx\n    let user\n    if (update) {\n      try {\n\n        // get updated user\n        const { data } = await api.get('user')\n        user = data\n\n        // set user to cookies\n        nookies.set(ctx, 'user', JSON.stringify(user), { path: '/' })\n\n      } catch(error) { }\n    } else {\n      const { user: userString } = nookies.get(ctx, 'user')\n      user = SafeJSONParse(userString).value\n    }\n    if ( ! user ) {\n      const { pathname, res } = ctx\n      const redirectRoute = `/login?redirectTo=${pathname}`\n      console.log('redirectroute', redirectRoute)\n      if (res) {\n        res.redirect(redirectRoute)\n        res.end()\n      } else {\n        Router.replace(redirectRoute)\n      }\n      return { }\n    }\n    if (WrappedComponent.getInitialProps) {\n\n      // append user to the context\n      ctx.user = user\n\n      const componentProps = await WrappedComponent.getInitialProps(ctx)\n      return { user, ...componentProps }\n    } else {\n      return { user }\n    }\n  }\n\n  WithAuth.displayName = `WithAuth(${getDisplayName(WrappedComponent)})`;\n\n  // wrap this hoc on withApi hoc\n  return withApi(WithAuth)\n}\n\nfunction getDisplayName(WrappedComponent) {\n  return WrappedComponent.displayName || WrappedComponent.name || 'Component';\n}\n\nexport default withAuth\n"]},"metadata":{},"sourceType":"script"}