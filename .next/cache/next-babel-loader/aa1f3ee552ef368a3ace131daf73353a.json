{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _jsonParseSafe = _interopRequireDefault(require(\"json-parse-safe\"));\n\nvar _react = _interopRequireWildcard(require(\"react\"));\n\nvar _router = _interopRequireDefault(require(\"next/router\"));\n\nvar _nookies = _interopRequireDefault(require(\"nookies\"));\n\nvar _UserContext = _interopRequireDefault(require(\"~/contexts/UserContext\"));\n\nvar _withApi = _interopRequireDefault(require(\"~/components/withApi\"));\n\nimport React from \"react\";\nvar __jsx = React.createElement;\n\nfunction _getRequireWildcardCache() { if (typeof WeakMap !== \"function\") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nconst withAuth = (WrappedComponent, update = false) => {\n  const WithAuth = props => {\n    const {\n      user,\n      updateUser\n    } = (0, _react.useContext)(_UserContext.default);\n    (0, _react.useEffect)(_ => {\n      if (!user) {\n        _router.default.push('/');\n      }\n    }, [user]);\n    return __jsx(WrappedComponent, _extends({\n      updateUser: updateUser\n    }, props));\n  };\n\n  WithAuth.getInitialProps = async ctx => {\n    const {\n      api\n    } = ctx;\n    let user;\n\n    if (update) {\n      try {\n        // get updated user\n        const {\n          data\n        } = await api.get('user');\n        user = data; // set user to cookies\n\n        _nookies.default.set(ctx, 'user', JSON.stringify(user), {\n          path: '/'\n        });\n      } catch (error) {}\n    } else {\n      const {\n        user: userString\n      } = _nookies.default.get(ctx, 'user');\n\n      user = (0, _jsonParseSafe.default)(userString).value;\n    }\n\n    if (!user) {\n      const {\n        pathname,\n        res\n      } = ctx;\n      const redirectRoute = `/login?redirectTo=${pathname}`;\n      console.log('redirectroute', redirectRoute);\n\n      if (res) {\n        res.redirect(redirectRoute);\n        res.end();\n      } else {\n        _router.default.replace(redirectRoute);\n      }\n\n      return {};\n    }\n\n    if (WrappedComponent.getInitialProps) {\n      // append user to the context\n      ctx.user = user;\n      const componentProps = await WrappedComponent.getInitialProps(ctx);\n      return _objectSpread({\n        user\n      }, componentProps);\n    } else {\n      return {\n        user\n      };\n    }\n  };\n\n  WithAuth.displayName = `WithAuth(${getDisplayName(WrappedComponent)})`; // wrap this hoc on withApi hoc\n\n  return (0, _withApi.default)(WithAuth);\n};\n\nfunction getDisplayName(WrappedComponent) {\n  return WrappedComponent.displayName || WrappedComponent.name || 'Component';\n}\n\nvar _default = withAuth;\nexports.default = _default;","map":{"version":3,"sources":["/Users/rafael/Projects/somosgad/dale/components/withAuth/index.js"],"names":["withAuth","WrappedComponent","update","WithAuth","props","user","updateUser","UserContext","_","Router","push","getInitialProps","ctx","api","data","get","nookies","set","JSON","stringify","path","error","userString","value","pathname","res","redirectRoute","console","log","redirect","end","replace","componentProps","displayName","getDisplayName","name"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;AAEA,MAAMA,QAAQ,GAAG,CAACC,gBAAD,EAAmBC,MAAM,GAAG,KAA5B,KAAsC;AAErD,QAAMC,QAAQ,GAAGC,KAAK,IAAI;AACxB,UAAM;AAAEC,MAAAA,IAAF;AAAQC,MAAAA;AAAR,QAAuB,uBAAWC,oBAAX,CAA7B;AACA,0BAAWC,CAAC,IAAI;AACd,UAAK,CAAEH,IAAP,EAAa;AACXI,wBAAOC,IAAP,CAAY,GAAZ;AACD;AACF,KAJD,EAIG,CAACL,IAAD,CAJH;AAKA,WAAO,MAAC,gBAAD;AAAkB,MAAA,UAAU,EAAEC;AAA9B,OAA8CF,KAA9C,EAAP;AACD,GARD;;AAUAD,EAAAA,QAAQ,CAACQ,eAAT,GAA2B,MAAMC,GAAN,IAAa;AACtC,UAAM;AAAEC,MAAAA;AAAF,QAAUD,GAAhB;AACA,QAAIP,IAAJ;;AACA,QAAIH,MAAJ,EAAY;AACV,UAAI;AAEF;AACA,cAAM;AAAEY,UAAAA;AAAF,YAAW,MAAMD,GAAG,CAACE,GAAJ,CAAQ,MAAR,CAAvB;AACAV,QAAAA,IAAI,GAAGS,IAAP,CAJE,CAMF;;AACAE,yBAAQC,GAAR,CAAYL,GAAZ,EAAiB,MAAjB,EAAyBM,IAAI,CAACC,SAAL,CAAed,IAAf,CAAzB,EAA+C;AAAEe,UAAAA,IAAI,EAAE;AAAR,SAA/C;AAED,OATD,CASE,OAAMC,KAAN,EAAa,CAAG;AACnB,KAXD,MAWO;AACL,YAAM;AAAEhB,QAAAA,IAAI,EAAEiB;AAAR,UAAuBN,iBAAQD,GAAR,CAAYH,GAAZ,EAAiB,MAAjB,CAA7B;;AACAP,MAAAA,IAAI,GAAG,4BAAciB,UAAd,EAA0BC,KAAjC;AACD;;AACD,QAAK,CAAElB,IAAP,EAAc;AACZ,YAAM;AAAEmB,QAAAA,QAAF;AAAYC,QAAAA;AAAZ,UAAoBb,GAA1B;AACA,YAAMc,aAAa,GAAI,qBAAoBF,QAAS,EAApD;AACAG,MAAAA,OAAO,CAACC,GAAR,CAAY,eAAZ,EAA6BF,aAA7B;;AACA,UAAID,GAAJ,EAAS;AACPA,QAAAA,GAAG,CAACI,QAAJ,CAAaH,aAAb;AACAD,QAAAA,GAAG,CAACK,GAAJ;AACD,OAHD,MAGO;AACLrB,wBAAOsB,OAAP,CAAeL,aAAf;AACD;;AACD,aAAO,EAAP;AACD;;AACD,QAAIzB,gBAAgB,CAACU,eAArB,EAAsC;AAEpC;AACAC,MAAAA,GAAG,CAACP,IAAJ,GAAWA,IAAX;AAEA,YAAM2B,cAAc,GAAG,MAAM/B,gBAAgB,CAACU,eAAjB,CAAiCC,GAAjC,CAA7B;AACA;AAASP,QAAAA;AAAT,SAAkB2B,cAAlB;AACD,KAPD,MAOO;AACL,aAAO;AAAE3B,QAAAA;AAAF,OAAP;AACD;AACF,GAxCD;;AA0CAF,EAAAA,QAAQ,CAAC8B,WAAT,GAAwB,YAAWC,cAAc,CAACjC,gBAAD,CAAmB,GAApE,CAtDqD,CAwDrD;;AACA,SAAO,sBAAQE,QAAR,CAAP;AACD,CA1DD;;AA4DA,SAAS+B,cAAT,CAAwBjC,gBAAxB,EAA0C;AACxC,SAAOA,gBAAgB,CAACgC,WAAjB,IAAgChC,gBAAgB,CAACkC,IAAjD,IAAyD,WAAhE;AACD;;eAEcnC,Q","sourcesContent":["import SafeJSONParse from 'json-parse-safe'\nimport React, { useContext, useEffect } from 'react'\nimport Router from 'next/router'\nimport nookies from 'nookies'\nimport UserContext from '~/contexts/UserContext'\nimport withApi from '~/components/withApi'\n\nconst withAuth = (WrappedComponent, update = false) => {\n\n  const WithAuth = props => {\n    const { user, updateUser } = useContext(UserContext)\n    useEffect( _ => {\n      if ( ! user) {\n        Router.push('/')\n      }\n    }, [user])\n    return <WrappedComponent updateUser={updateUser} {...props} />\n  }\n\n  WithAuth.getInitialProps = async ctx => {\n    const { api } = ctx\n    let user\n    if (update) {\n      try {\n\n        // get updated user\n        const { data } = await api.get('user')\n        user = data\n\n        // set user to cookies\n        nookies.set(ctx, 'user', JSON.stringify(user), { path: '/' })\n\n      } catch(error) { }\n    } else {\n      const { user: userString } = nookies.get(ctx, 'user')\n      user = SafeJSONParse(userString).value\n    }\n    if ( ! user ) {\n      const { pathname, res } = ctx\n      const redirectRoute = `/login?redirectTo=${pathname}`\n      console.log('redirectroute', redirectRoute)\n      if (res) {\n        res.redirect(redirectRoute)\n        res.end()\n      } else {\n        Router.replace(redirectRoute)\n      }\n      return { }\n    }\n    if (WrappedComponent.getInitialProps) {\n\n      // append user to the context\n      ctx.user = user\n\n      const componentProps = await WrappedComponent.getInitialProps(ctx)\n      return { user, ...componentProps }\n    } else {\n      return { user }\n    }\n  }\n\n  WithAuth.displayName = `WithAuth(${getDisplayName(WrappedComponent)})`;\n\n  // wrap this hoc on withApi hoc\n  return withApi(WithAuth)\n}\n\nfunction getDisplayName(WrappedComponent) {\n  return WrappedComponent.displayName || WrappedComponent.name || 'Component';\n}\n\nexport default withAuth\n"]},"metadata":{},"sourceType":"script"}